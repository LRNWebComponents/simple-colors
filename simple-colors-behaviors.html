<!--
`simple-colors-behaviors`
A set of theming and accent color behaviors for components.
@microcopy - the mental model for this element
 - 
 - 
-->
<script>
  window.simpleColorsBehaviors = window.simpleColorsBehaviors || {};
  window.simpleColorsBehaviors = {
    properties: {
      /** 
        * Accent color on UI. Default is greyscale.
        */ 
      accentColor: {
        type: String,
        value: null,
        reflectToAttribute: true,
      },
      /** 
        * Dark colors for UI? Default is false (light).
        */
      dark: {
        type: Boolean,
        value: false,
        reflectToAttribute: true
      },
    },

    observers: ['setTheme(accentColor,dark)'],
    /** 
     * Set color variables. Set variables for element and for slotted content.
     */
    created: function(){
      Polymer.SimpleColorsUtility.requestAvailability();
      this.__hexCodes = Polymer.SimpleColorsUtility.instance.hexCodes;
      this.__variables = Polymer.SimpleColorsUtility.instance.variables;
      this.reset();
    },

    setTheme: function(accentColor,dark){
      if(accentColor!== null && accentColor!==""){
        let prop = accentColor.replace(/-([a-z])/g, function (g) { return g[1].toUpperCase(); });
        if(this.__lightTheme.hasOwnProperty(prop)){
          this.__lightTheme.accent = this.__lightTheme[prop].slice();
          this.__darkTheme.accent = this.__darkTheme[prop].slice();
        } else {
          this.__lightTheme.accent = this.__defaultAccent.slice();
          this.__lightTheme.accent = this.__defaultAccent.slice().reverse();
        }
      }
      this.setThemeProps('--simple-colors-light-theme-',this.__lightTheme);
      this.setThemeProps('--simple-colors-dark-theme-',this.__darkTheme);
      
      if(dark){
        this.setThemeProps('--simple-colors-',this.__darkTheme);
      } else {
        this.setThemeProps('--simple-colors-',this.__lightTheme);
        
      }
    },
    
    _setProps: function(prefix,colors){
      prefix = prefix.replace('-grey','').replace( /([a-z])([A-Z])/g, '$1-$2' ).toLowerCase();
      for(let i=0; i<colors.length; i++){
        let half = colors.length/2, suffix = i < half ? '-foreground'+(i+1) : '-background'+(colors.length-i);
        //console.log('setting '+prefix+suffix+' to '+colors[i]);
        if (this.customStyle !== null && this.customStyle[prefix+suffix] !== null) this.customStyle[prefix+suffix] = colors[i];
      }
      this.updateStyles();
    },
    setThemeProps: function(themePrefix,theme){
      for (var property in theme) {
        if (theme.hasOwnProperty(property)) {
          this._setProps(themePrefix+property,theme[property]);
        }
      }
    },
    reset: function(){
      let setThemeProps= function(themePrefix,theme){
        for (var property in theme) {
          if (theme.hasOwnProperty(property)) {
            this._setProps(themePrefix+property,theme[property]);
          }
        }
      };
      this.__lightTheme = this.__hexCodes;
      this.__darkTheme = {};
      for (var property in this.hexCodes) {
        if (this.hexCodes.hasOwnProperty(property)) {
          this.__darkTheme[property] = this.__lightTheme[property].slice().reverse();
        }
      }
      this.setThemeProps('--simple-colors-',this.__lightTheme);
      this.setThemeProps('--simple-colors-light-theme-',this.__lightTheme);
      this.setThemeProps('--simple-colors-dark-theme-',this.__darkTheme);
    },
    getContrasts: function(theme,isColor,isForeground,level,isSmallText) {
      //let labels = color.replace('--simple-colors-').split('-').reverse(), isForeground = labels[0].indexOf('foreground') === 0, level = parseInt(labels[0][labels[0].length-1]), isColor = labels[1] !== 'theme';
      isSmallText =  isSmallText !== undefined ? isSmallText : true;
      /*  Small text requires the highest contrast ratio for WCAG 2.0 AA compliance. 
          Small text is any content that is NOT:
          - bold text that is 14 point or higher,
          - text that is 18 point or higher,
          - a decorative element that has no semantic meaning, such as a border, or
          - a disabled UI element */
      let results = [], wcagaa = [
        //level 1
        {
          "colors": {"small": [1,2,3,4], "largeOnly": [5]}, 
          "greys": {"small": [1,2,3,4,5], "largeOnly": []} 
        },
        //level 2
        {
          "colors": {"small": [1,2,3], "largeOnly": [4]}, 
          "greys": {"small": [1,2,3,4,5], "largeOnly": []} 
        },
        //level 3
        {
          "colors": {"small": [1,2,3], "largeOnly": []}, 
          "greys": {"small": [1,2,3,4], "largeOnly": [5]} 
        },
        //level 4
        {
          "colors": {"small": [1], "largeOnly": [2]}, 
          "greys": {"small": [1,2,3,4], "largeOnly": []} 
        },
        //level 5
        {
          "colors": {"small": [], "largeOnly": [1]}, 
          "greys": {"small": [1], "largeOnly": [2]} 
        }
      ];
      let data1 = wcagaa[level-1], data2 = isColor ? data1.colors : data1.greys, colors = data2.small.slice(0);
      if(!isSmallText) {
        colors = colors.concat(data2.largeOnly);
      }
      for(let i = 0; i<colors.length; i++){
        let suffix = isForeground ? '-background'+colors[i] : '-foreground'+level;
        for (var property in this.__hexCodes) {
          if(property !== 'colorLevels'){
            let color = property === 'grey' ? '' : '-'+property.replace( /([a-z])([A-Z])/g, '$1-$2' ).toLowerCase(), cssVar =  '--simple-colors-'+theme+'-theme'+color+suffix, hex = this.__variables[cssVar];
            results.push({"variable": cssVar, "hexCode": hex});
          }
        }
      }
      return results;
    }
  };
</script>

